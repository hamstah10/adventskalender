<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers" data-namespace-typo3-fluid="true">

<f:layout name="Default" />

<f:section name="Content">
    
    <style>
        :root {
            --door-unlocked-start: <f:format.raw>{settings.doorUnlockedColorStart}</f:format.raw>;
            --door-unlocked-end: <f:format.raw>{settings.doorUnlockedColorEnd}</f:format.raw>;
            --door-locked-start: <f:format.raw>{settings.doorLockedColorStart}</f:format.raw>;
            --door-locked-end: <f:format.raw>{settings.doorLockedColorEnd}</f:format.raw>;
            --door-christmas-start: <f:format.raw>{settings.specialChristmasColorStart}</f:format.raw>;
            --door-christmas-end: <f:format.raw>{settings.specialChristmasColorEnd}</f:format.raw>;
            --door-nikolaus-start: <f:format.raw>{settings.specialNikolausColorStart}</f:format.raw>;
            --door-nikolaus-end: <f:format.raw>{settings.specialNikolausColorEnd}</f:format.raw>;
            --lightbox-accent: <f:format.raw>{settings.lightboxAccentColor}</f:format.raw>;
            --lightbox-bg: <f:format.raw>{settings.lightboxBackgroundColor}</f:format.raw>;
        }
        <f:if condition="{settings.snowEnabled} == '0'">
        .snowflake {
            display: none !important;
        }
        </f:if>

        /* Grid Layout Styles */
        .calendar-grid-wrapper {
            background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .calendar-grid {
            display: grid !important;
            grid-template-columns: repeat(6, 1fr) !important;
            gap: 1rem !important;
            max-width: 100% !important;
            margin: 0 auto !important;
            width: 100% !important;
        }

        .calendar-door {
            position: relative !important;
            aspect-ratio: 1 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            display: block !important;
            width: 100% !important;
        }

        .calendar-door:hover {
            transform: scale(1.05);
        }

        .calendar-door.locked {
            opacity: 0.6;
        }

        .calendar-door-inner {
            width: 100% !important;
            height: 100% !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 8px !important;
            font-weight: bold !important;
            position: relative !important;
            overflow: hidden !important;
            border: 3px solid rgba(255, 255, 255, 0.2) !important;
            font-size: clamp(0.8rem, 2vw, 1.5rem) !important;
            text-decoration: none !important;
        }

        .calendar-door.unlocked .calendar-door-inner {
            background: linear-gradient(135deg, var(--door-unlocked-start) 0%, var(--door-unlocked-end) 100%);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .calendar-door.unlocked.special-christmas .calendar-door-inner {
            background: linear-gradient(135deg, var(--door-christmas-start) 0%, var(--door-christmas-end) 100%);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .calendar-door.unlocked.special-nikolaus .calendar-door-inner {
            background: linear-gradient(135deg, var(--door-nikolaus-start) 0%, var(--door-nikolaus-end) 100%);
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.3);
        }

        .calendar-door.locked .calendar-door-inner {
            background: linear-gradient(135deg, var(--door-locked-start) 0%, var(--door-locked-end) 100%);
            box-shadow: 0 5px 15px rgba(158, 158, 158, 0.3);
        }

        .calendar-door-number {
            position: absolute;
            top: 5px;
            right: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
        }

        .calendar-door-icon {
            font-size: 2em;
            margin-bottom: 0.3rem;
            display: block;
        }

        .calendar-door-title {
            font-size: 0.7em;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            padding: 0 3px;
        }

        .calendar-door.locked .calendar-door-title {
            display: none;
        }

        .calendar-door.locked .calendar-door-icon {
            font-size: 1.5em;
        }

        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 0.8rem !important;
            }
        }

        @media (max-width: 480px) {
            .calendar-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 0.6rem !important;
            }
            .calendar-grid-wrapper {
                padding: 1rem !important;
            }
        }
    </style>
    
    <!-- Hintergrundmusik -->
    <f:if condition="{settings.musicEnabled}">
        <audio loop id="backgroundMusic">
            <source src="{settings.musicPath}" type="audio/mpeg">
        </audio>
        
        <button id="musicToggle" class="music-toggle-btn" onclick="toggleMusic()">
            <f:translate key="LLL:EXT:adventskalender/Resources/Private/Language/locallang.xlf:music.on" />
        </button>
    </f:if>
    
    <audio id="zonkSound">
        <source src="/_assets/650af2e25ff4c4dcc48a2c838cf21ed4/Music/Zonk-sound.mp3" type="audio/mpeg">
    </audio>
    
    <img src="/_assets/650af2e25ff4c4dcc48a2c838cf21ed4/Images/pferd.png" alt="Pferd" class="deco-horse">
    <img src="/_assets/650af2e25ff4c4dcc48a2c838cf21ed4/Images/renntier.png" alt="Rentier" class="deco-reindeer">

    <f:variable name="bgImageUrl">{f:if(condition: '{settings.backgroundImage}', then: '{f:uri.resource(path: \'EXT:adventskalender/Resources/Public/Images/{settings.backgroundImage}\')}')}</f:variable>
    <div class="adventskalender-wrapper p-1 p-lg-5" style="{f:if(condition: '{settings.backgroundImage}', then: 'background-image: url({bgImageUrl});')}">
       <div class="container">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold mb-3 animate__animated animate__fadeInDown">
                    <span class="christmas-icon">üéÑ</span> 
                    {f:if(condition: '{settings.customTitle}', then: '{settings.customTitle}', else: '{f:translate(key: \'LLL:EXT:adventskalender/Resources/Private/Language/locallang.xlf:title\')}')}
                    <span class="christmas-icon">üéÑ</span>
                </h1>
                <p class="lead animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                    {f:if(condition: '{settings.customDescription}', then: '{settings.customDescription}', else: '{f:translate(key: \'LLL:EXT:adventskalender/Resources/Private/Language/locallang.xlf:subtitle\')}')}
                </p>
            </div>
            
            <div class="calendar-grid-wrapper animate__animated animate__fadeInUp animate__slower">
                <div class="calendar-grid">
                    <f:for each="{0..23}" as="day">
                        <f:variable name="dayNumber" value="{day + 1}" />
                        <f:for each="{doors}" as="door">
                            <f:if condition="{door.day} == {dayNumber}">
                                <f:if condition="{currentMonth} == 12 AND {door.day} <= {currentDay}">
                                    <f:then>
                                        <a href="#" class="calendar-door unlocked {f:if(condition: '{door.day} == 24', then: 'special-christmas')} {f:if(condition: '{door.day} == 6', then: 'special-nikolaus')}" onclick="openLightbox({door.uid}); return false;" style="{f:if(condition: '{door.customStyle}', then: 'background: linear-gradient(135deg, {door.customColorStart} 0%, {door.customColorEnd} 100%);')}">
                                            <div class="calendar-door-inner">
                                                <div class="calendar-door-number">{door.day}</div>
                                                <f:switch expression="{door.day}">
                                                    <f:case value="1"><span class="calendar-door-icon">üéÅ</span></f:case>
                                                    <f:case value="2"><span class="calendar-door-icon">‚≠ê</span></f:case>
                                                    <f:case value="3"><span class="calendar-door-icon">‚ùÑÔ∏è</span></f:case>
                                                    <f:case value="4"><span class="calendar-door-icon">üîî</span></f:case>
                                                    <f:case value="5"><span class="calendar-door-icon">üïØÔ∏è</span></f:case>
                                                    <f:case value="6"><span class="calendar-door-icon">üéÖ</span></f:case>
                                                    <f:case value="7"><span class="calendar-door-icon">ü¶å</span></f:case>
                                                    <f:case value="8"><span class="calendar-door-icon">‚õÑ</span></f:case>
                                                    <f:case value="9"><span class="calendar-door-icon">üé∂</span></f:case>
                                                    <f:case value="10"><span class="calendar-door-icon">üåü</span></f:case>
                                                    <f:case value="11"><span class="calendar-door-icon">üß¶</span></f:case>
                                                    <f:case value="12"><span class="calendar-door-icon">üç™</span></f:case>
                                                    <f:case value="13"><span class="calendar-door-icon">üéÄ</span></f:case>
                                                    <f:case value="14"><span class="calendar-door-icon">üè†</span></f:case>
                                                    <f:case value="15"><span class="calendar-door-icon">üéµ</span></f:case>
                                                    <f:case value="16"><span class="calendar-door-icon">ü•æ</span></f:case>
                                                    <f:case value="17"><span class="calendar-door-icon">ü™î</span></f:case>
                                                    <f:case value="18"><span class="calendar-door-icon">üéä</span></f:case>
                                                    <f:case value="19"><span class="calendar-door-icon">üéâ</span></f:case>
                                                    <f:case value="20"><span class="calendar-door-icon">üé∫</span></f:case>
                                                    <f:case value="21"><span class="calendar-door-icon">üëº</span></f:case>
                                                    <f:case value="22"><span class="calendar-door-icon">üéÄ</span></f:case>
                                                    <f:case value="23"><span class="calendar-door-icon">‚õ™</span></f:case>
                                                    <f:case value="24"><span class="calendar-door-icon">üéÑ</span></f:case>
                                                </f:switch>
                                                <div class="calendar-door-title">{door.title}</div>
                                            </div>
                                        </a>
                                    </f:then>
                                    <f:else>
                                        <div class="calendar-door locked" onclick="playZonkSound()">
                                            <div class="calendar-door-inner">
                                                <div class="calendar-door-number">{door.day}</div>
                                                <span class="calendar-door-icon">üîí</span>
                                            </div>
                                        </div>
                                    </f:else>
                                </f:if>
                            </f:if>
                        </f:for>
                    </f:for>
                </div>
            </div>
        
            <f:for each="{doors}" as="door">
                <div class="lightbox" id="lightbox{door.uid}" style="display: none;">
                    <div class="lightbox-overlay" onclick="closeLightbox({door.uid})"></div>
                    <div class="lightbox-content">
                        <div class="lightbox-day-badge">{door.day}</div>
                        <button class="lightbox-close" onclick="closeLightbox({door.uid})">&times;</button>
                        <div class="lightbox-header">
                            <h2 class="fs-3 fw-bold">
                                <f:switch expression="{door.day}">
                                    <f:case value="1"><span class="lightbox-icon">üéÅ</span></f:case>
                                    <f:case value="2"><span class="lightbox-icon">‚≠ê</span></f:case>
                                    <f:case value="3"><span class="lightbox-icon">‚ùÑÔ∏è</span></f:case>
                                    <f:case value="4"><span class="lightbox-icon">üîî</span></f:case>
                                    <f:case value="5"><span class="lightbox-icon">üïØÔ∏è</span></f:case>
                                    <f:case value="6"><span class="lightbox-icon">üéÖ</span></f:case>
                                    <f:case value="7"><span class="lightbox-icon">ü¶å</span></f:case>
                                    <f:case value="8"><span class="lightbox-icon">‚õÑ</span></f:case>
                                    <f:case value="9"><span class="lightbox-icon">üé∂</span></f:case>
                                    <f:case value="10"><span class="lightbox-icon">üåü</span></f:case>
                                    <f:case value="11"><span class="lightbox-icon">üß¶</span></f:case>
                                    <f:case value="12"><span class="lightbox-icon">üç™</span></f:case>
                                    <f:case value="13"><span class="lightbox-icon">üéÄ</span></f:case>
                                    <f:case value="14"><span class="lightbox-icon">üè†</span></f:case>
                                    <f:case value="15"><span class="lightbox-icon">üéµ</span></f:case>
                                    <f:case value="16"><span class="lightbox-icon">ü•æ</span></f:case>
                                    <f:case value="17"><span class="lightbox-icon">ü™î</span></f:case>
                                    <f:case value="18"><span class="lightbox-icon">üéä</span></f:case>
                                    <f:case value="19"><span class="lightbox-icon">üéâ</span></f:case>
                                    <f:case value="20"><span class="lightbox-icon">üé∫</span></f:case>
                                    <f:case value="21"><span class="lightbox-icon">üëº</span></f:case>
                                    <f:case value="22"><span class="lightbox-icon">üéÄ</span></f:case>
                                    <f:case value="23"><span class="lightbox-icon">‚õ™</span></f:case>
                                    <f:case value="24"><span class="lightbox-icon">üéÑ</span></f:case>
                                </f:switch> {door.title}
                            </h2>
                        </div>
                        <div class="lightbox-body">
                            <f:if condition="{door.voucher}">
                            <f:then>
                                <div class="lightbox-grid">
                                      <div class="lightbox-content-col">
                                    <f:if condition="{door.image}">
                                        <div class="door-image mb-4 text-center">
                                            <f:image image="{door.image}" alt="{door.title}" class="img-fluid rounded shadow" style="max-height: 400px;" />
                                        </div>
                                    </f:if>
                                    
                                    <f:if condition="{door.video}">
                                        <div class="door-video mb-4 text-center">
                                            <video controls class="w-100 rounded shadow" style="max-height: 400px;">
                                                <source src="{door.video.originalResource.publicUrl}" type="{door.video.originalResource.mimeType}">
                                                Dein Browser unterst√ºtzt keine Videos.
                                            </video>
                                        </div>
                                    </f:if>
                                    
                                    <f:if condition="{door.audio}">
                                        <div class="door-audio mb-4">
                                            <audio controls class="w-100">
                                                <source src="{door.audio.originalResource.publicUrl}" type="{door.audio.originalResource.mimeType}">
                                                Dein Browser unterst√ºtzt keine Audio-Dateien.
                                            </audio>
                                        </div>
                                    </f:if>
                                    
                                    <f:if condition="{door.description}">
                                        <div class="door-description mb-4">
                                            <div class="alert alert-danger bg-opacity-10 border-danger">
                                                <i class="bi bi-info-circle"></i> {door.description}
                                            </div>
                                        </div>
                                    </f:if>
                                    
                                    <f:if condition="{door.content}">
                                        <div class="door-content mb-4">
                                            <f:format.html>{door.content}</f:format.html>
                                        </div>
                                    </f:if>
                                    
                                    <f:if condition="{door.link}">
                                        <div class="door-link text-center">
                                            <a href="{door.link}" target="_blank" class="btn btn-outline-danger btn-lg">
                                                <i class="bi bi-link-45deg"></i> <f:translate key="LLL:EXT:adventskalender/Resources/Private/Language/locallang.xlf:link.open" />
                                            </a>
                                        </div>
                                    </f:if>
                                        </div>

                                        <div class="lightbox-voucher-col">
                                            <f:render partial="Voucher" arguments="{voucher: door.voucher, settings: settings, day: door.day}" />
                                        </div>
                                    </div>
                                </f:then>
                                <f:else>
                                    <div class="lightbox-content-col">
                                    <f:if condition="{door.image}">
                                        <div class="door-image mb-4 text-center">
                                            <f:image image="{door.image}" alt="{door.title}" class="img-fluid rounded shadow" style="max-height: 400px;" />
                                        </div>
                                    </f:if>
                                    
                                    <f:if condition="{door.video}">
                                        <div class="door-video mb-4 text-center">
                                            <video controls class="w-100 rounded shadow" style="max-height: 400px;">
                                                <source src="{door.video.originalResource.publicUrl}" type="{door.video.originalResource.mimeType}">
                                                Dein Browser unterst√ºtzt keine Videos.
                                            </video>
                                        </div>
                                    </f:if>
                                    
                                    <f:if condition="{door.audio}">
                                        <div class="door-audio mb-4">
                                            <audio controls class="w-100">
                                                <source src="{door.audio.originalResource.publicUrl}" type="{door.audio.originalResource.mimeType}">
                                                Dein Browser unterst√ºtzt keine Audio-Dateien.
                                            </audio>
                                        </div>
                                    </f:if>
                                    
                                    <f:if condition="{door.description}">
                                        <div class="door-description mb-4">
                                            <div class="alert alert-danger bg-opacity-10 border-danger">
                                                <i class="bi bi-info-circle"></i> {door.description}
                                            </div>
                                        </div>
                                    </f:if>
                                    
                                    <f:if condition="{door.content}">
                                        <div class="door-content mb-4">
                                            <f:format.html>{door.content}</f:format.html>
                                        </div>
                                    </f:if>
                                    
                                    <f:if condition="{door.link}">
                                        <div class="door-link text-center">
                                            <a href="{door.link}" target="_blank" class="btn btn-outline-danger btn-lg">
                                                <i class="bi bi-link-45deg"></i> <f:translate key="LLL:EXT:adventskalender/Resources/Private/Language/locallang.xlf:link.open" />
                                            </a>
                                        </div>
                                    </f:if>
                                        </div>
                                </f:else>
                                </f:if>
                        </div>
                    </div>
                </div>
            </f:for>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        let isPlaying = false;
        function toggleMusic() {
            const audio = document.getElementById('backgroundMusic');
            const btn = document.getElementById('musicToggle');
            if (isPlaying) {
                audio.pause();
                btn.innerHTML = '<f:translate key="LLL:EXT:adventskalender/Resources/Private/Language/locallang.xlf:music.on" />';
            } else {
                audio.play();
                btn.innerHTML = '<f:translate key="LLL:EXT:adventskalender/Resources/Private/Language/locallang.xlf:music.off" />';
            }
            isPlaying = !isPlaying;
        }
        
        function openLightbox(uid) {
            document.getElementById('lightbox' + uid).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeLightbox(uid) {
            document.getElementById('lightbox' + uid).style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function playZonkSound() {
            const zonk = document.getElementById('zonkSound');
            zonk.currentTime = 0;
            zonk.play();
        }
        
        function downloadVoucher() {
             const voucher = document.getElementById('voucherElement');
             if (!voucher) return;
             
             html2canvas(voucher, {
                 backgroundColor: '#ffffff',
                 scale: 2,
                 logging: false
             }).then(canvas => {
                 const link = document.createElement('a');
                 link.download = 'Gutschein.png';
                 link.href = canvas.toDataURL('image/png');
                 link.click();
             });
         }
    </script>
    
</f:section>

</html>
